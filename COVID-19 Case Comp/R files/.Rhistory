rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7)))
#
# Model Negative Binomial GAM
#
# PCA
names(df)
mobility <- names(df)[8:13]
ids <- which(apply(!is.na(df[,..mobility]),1,all))
mobility
str(mobility)
names(data_dis)
mobility <- names(data_dis)[8:13]
mobility
names(df)
str(df)
str(data_dis)
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data = data.table(data)
data$date = as.Date(data$date)
colnames(data)
rs7 = function(x) {
rs = rep(NA, length(x))
for (i in 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[1:(m-n)]
} else {
shifted_x[-1:n] = x[-1:n]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7))) %>%
ungroup()
# PCA
names(data)
mobility <- names(data)[8:13]
ids <- which(apply(!is.na(data[,..mobility]),1,all))
str(data)
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
# create 7-day rolling sum of new cases
rs7 = function(x) {
rs = rep(NA, length(x))
for (i in 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[1:(m-n)]
} else {
shifted_x[-1:n] = x[-1:n]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7))) %>%
ungroup()
data = data.table(data)
# PCA
names(data)
mobility <- names(data)[8:13]
ids <- which(apply(!is.na(data[,..mobility]),1,all))
pca_mobility <- princomp(data[ids,..mobility], cor = T)
plot(pca_mobility)
pca_mobility$loadings
data[ids, pca1 := pca_mobility$scores[,1]]
data[ids, pca2 := pca_mobility$scores[,2]]
data[ids, pca3 := pca_mobility$scores[,3]]
# Formula
formula <- new_cases_f7 ~ s(new_cases, k = 7) + s(new_cases_p2, k = 7) + s(new_cases_p4, k = 7) + s(new_cases_p6, k = 7) +
s(new_cases_p7, k = 7) + population:pca1 + population:pca2 + population:pca3 + pop_density + region
id <- which(apply(!is.na(cbind(data[,..mobility],data[,..cases])), 1, all))
data2 <- data[id,]
# Model
nb_mod <- gam(formula, data, family = nb(link="sqrt"))
colnames(data)
# Formula
formula <- rs_f7 ~ s(new_rs, k = 7) + s(rsp2, k = 7) + s(rsp2, k = 7) + s(rsp6, k = 7) +
s(rsp7, k = 7) + population:pca1 + population:pca2 + population:pca3 + pop_density + region
id <- which(apply(!is.na(cbind(data[,..mobility],data[,..cases])), 1, all))
data2 <- data[id,]
# Model
nb_mod <- gam(formula, data, family = nb(link="sqrt"))
# Formula
formula <- rsf7 ~ s(new_rs, k = 7) + s(rsp2, k = 7) + s(rsp2, k = 7) + s(rsp6, k = 7) +
s(rsp7, k = 7) + population:pca1 + population:pca2 + population:pca3 + pop_density + region
id <- which(apply(!is.na(cbind(data[,..mobility],data[,..cases])), 1, all))
data2 <- data[id,]
# Model
nb_mod <- gam(formula, data, family = nb(link="sqrt"))
head(data)
head(data, 20)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
# create 7-day rolling sum of new cases
rs7 = function(x) {
rs = rep(NA, length(x))
for (i in 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[1:(m-n)]
} else {
shifted_x[-1:n] = x[-1:n]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7))) %>%
ungroup()
head(data)
head(data$rsf7)
x = 1:100
shift_n(x, 7)
shift_n(x, -5)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[n:m]
} else {
shifted_x[-1:n] = x[n:m]
}
return(shifted_x)
}
x = 1:100
shift_n(x, 7)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[n-1:m]
} else {
shifted_x[-1:n] = x[n:m]
}
return(shifted_x)
}
shift_n(x, 7)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n-1):m]
} else {
shifted_x[-1:n] = x[n:m]
}
return(shifted_x)
}
shift_n(x, 7)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[n:m]
}
return(shifted_x)
}
shift_n(x, 7)
shift_n(x, -5)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[-n:m]
}
return(shifted_x)
}
shift_n(x, -5)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[1:(m+n)]
}
return(shifted_x)
}
shift_n(x, -5)
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
# create 7-day rolling sum of new cases
rs7 = function(x) {
rs = rep(NA, length(x))
for (i in 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[1:(m+n)]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7))) %>%
ungroup()
data = data.table(data)
head(data$rsf7)
data$rsf7
temp = filter(data, region == "Duram")
temp$rsf7
temp$rsf7
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7)))
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7)))
data = data.table(data)
temp = filter(data, region == "Duram")
temp$rsf7
dur = filter(data, region == "Duram")
str(dur)
temp = filter(data, region == "Durham")
temp = filter(data, region == "Duram")
temp = filter(data, region == "Durham")
temp$rsf7
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
# create 7-day rolling sum of new cases
rs7 = function(x) {
rs = rep(NA, length(x))
for (i in 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[1:(m+n)]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7)))
data = data.table(data)
names(data)
mobility <- names(data)[8:13]
ids <- which(apply(!is.na(data[,..mobility]),1,all))
pca_mobility <- princomp(data[ids,..mobility], cor = T)
plot(pca_mobility)
pca_mobility$loadings
data[ids, pca1 := pca_mobility$scores[,1]]
data[ids, pca2 := pca_mobility$scores[,2]]
data[ids, pca3 := pca_mobility$scores[,3]]
# Formula
formula <- rsf7 ~ s(new_rs, k = 7) + s(rsp2, k = 7) + s(rsp2, k = 7) + s(rsp6, k = 7) +
s(rsp7, k = 7) + population:pca1 + population:pca2 + population:pca3 + pop_density + region
id <- which(apply(!is.na(cbind(data[,..mobility],data[,..cases])), 1, all))
data2 <- data[id,]
# Model
nb_mod <- gam(formula, data, family = nb(link="sqrt"))
names(data)
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
# create 7-day rolling sum of new cases
rs7 = function(x) {
rs = rep(NA, length(x))
for (i in 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[1:(m+n)]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7)))
data = data.table(data)
names(data)
mobility <- names(data)[8:13]
cases <- grep("rs", names(data), value=T)
ids <- which(apply(!is.na(data[,..mobility]),1,all))
pca_mobility <- princomp(data[ids,..mobility], cor = T)
plot(pca_mobility)
pca_mobility$loadings
data[ids, pca1 := pca_mobility$scores[,1]]
data[ids, pca2 := pca_mobility$scores[,2]]
data[ids, pca3 := pca_mobility$scores[,3]]
# Formula
formula <- rsf7 ~ s(new_rs, k = 7) + s(rsp2, k = 7) + s(rsp2, k = 7) + s(rsp6, k = 7) +
s(rsp7, k = 7) + population:pca1 + population:pca2 + population:pca3 + pop_density + region
id <- which(apply(!is.na(cbind(data[,..mobility],data[,..cases])), 1, all))
data[,..cases]
data$rsp7
data$rsf7
data$rsp4
x = 1:100
shift_n(x, -5)
y = shift_n(x, -5)
rs7(y)
a = c(1, 2, NA, 3)
sum(a)
rs7 = function(x) {
rs = rep(NA, length(x))
j = 7
while(is.na(x[j]) & j < length(x)) {
j = j + 1
}
for (i in j + 7: length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
# create 7-day rolling sum of new cases
rs7 = function(x) {
rs = rep(NA, length(x))
j = 1
while(is.na(x[j]) & j < length(x)) {
j = j + 1
}
for (i in (j + 7): length(x)) {
rs[i] = sum(x[i-6: i])
}
return(rs)
}
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
path = file.path("..", "Datasets", "full_data.csv")
data = read.csv(path)
data$date = as.Date(data$date)
colnames(data)
shift_n = function(x, n) {
m = length(x)
shifted_x = rep(NA, m)
if (n > 0) {
shifted_x[1:(m - n)] = x[(n+1):m]
} else {
shifted_x[-1:n] = x[1:(m+n)]
}
return(shifted_x)
}
data = data %>%
group_by(region) %>%
mutate(new_rs = rs7(new_cases),
rsf7 = rs7(shift_n(new_cases, 7)),
rsp1 = rs7(shift_n(new_cases, -1)),
rsp2 = rs7(shift_n(new_cases, -2)),
rsp3 = rs7(shift_n(new_cases, -3)),
rsp4 = rs7(shift_n(new_cases, -4)),
rsp5 = rs7(shift_n(new_cases, -5)),
rsp6 = rs7(shift_n(new_cases, -6)),
rsp7 = rs7(shift_n(new_cases, -7)))
data = data.table(data)
# PCA
names(data)
mobility <- names(data)[8:13]
cases <- grep("rs", names(data), value=T)
ids <- which(apply(!is.na(data[,..mobility]),1,all))
pca_mobility <- princomp(data[ids,..mobility], cor = T)
plot(pca_mobility)
pca_mobility$loadings
data[ids, pca1 := pca_mobility$scores[,1]]
data[ids, pca2 := pca_mobility$scores[,2]]
data[ids, pca3 := pca_mobility$scores[,3]]
# Formula
formula <- rsf7 ~ s(new_rs, k = 7) + s(rsp2, k = 7) + s(rsp2, k = 7) + s(rsp6, k = 7) +
s(rsp7, k = 7) + population:pca1 + population:pca2 + population:pca3 + pop_density + region
id <- which(apply(!is.na(cbind(data[,..mobility],data[,..cases])), 1, all))
data$rsp3
data$rsp1
x
x = 3
x
library(ggplot2)
library(data.table)
library(mgcv)
library(dplyr)
